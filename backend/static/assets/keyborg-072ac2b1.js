/*!
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * Licensed under the MIT License.
 */const y=typeof WeakRef<"u";class h{constructor(e){y&&typeof e=="object"?this._weakRef=new WeakRef(e):this._instance=e}deref(){var e,s,i;let t;return this._weakRef?(t=(e=this._weakRef)===null||e===void 0?void 0:e.deref(),t||delete this._weakRef):(t=this._instance,!((i=(s=t)===null||s===void 0?void 0:s.isDisposed)===null||i===void 0)&&i.call(s)&&delete this._instance),t}}/*!
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * Licensed under the MIT License.
 */const l="keyborg:focusin";function v(n){const e=n.HTMLElement,s=e.prototype.focus;let i=!1;return e.prototype.focus=function(){i=!0},n.document.createElement("button").focus(),e.prototype.focus=s,i}let _=!1;function F(n){const e=n.focus;e.__keyborgNativeFocus?e.__keyborgNativeFocus.call(n):n.focus()}function m(n){const e=n;_||(_=v(e));const s=e.HTMLElement.prototype.focus;if(s.__keyborgNativeFocus)return;e.HTMLElement.prototype.focus=t;const i=e.__keyborgData={focusInHandler:o=>{var c;const a=o.target;if(!a)return;const d=document.createEvent("HTMLEvents");d.initEvent(l,!0,!0);const f={relatedTarget:o.relatedTarget||void 0};(_||i.lastFocusedProgrammatically)&&(f.isFocusedProgrammatically=a===((c=i.lastFocusedProgrammatically)===null||c===void 0?void 0:c.deref()),i.lastFocusedProgrammatically=void 0),d.details=f,a.dispatchEvent(d)}};e.document.addEventListener("focusin",e.__keyborgData.focusInHandler,!0);function t(){const o=e.__keyborgData;return o&&(o.lastFocusedProgrammatically=new h(this)),s.apply(this,arguments)}t.__keyborgNativeFocus=s}function b(n){const e=n,s=e.HTMLElement.prototype,i=s.focus.__keyborgNativeFocus,t=e.__keyborgData;t&&(e.document.removeEventListener("focusin",t.focusInHandler,!0),delete e.__keyborgData),i&&(s.focus=i)}/*!
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * Licensed under the MIT License.
 */const k=500;let g=0;class p{constructor(){this.__keyborgCoreRefs={},this._isNavigatingWithKeyboard=!1}add(e){const s=e.id;s in this.__keyborgCoreRefs||(this.__keyborgCoreRefs[s]=new h(e))}remove(e){delete this.__keyborgCoreRefs[e],Object.keys(this.__keyborgCoreRefs).length===0&&(this._isNavigatingWithKeyboard=!1)}setVal(e){if(this._isNavigatingWithKeyboard!==e){this._isNavigatingWithKeyboard=e;for(const s of Object.keys(this.__keyborgCoreRefs)){const t=this.__keyborgCoreRefs[s].deref();t?t.update(e):this.remove(s)}}}getVal(){return this._isNavigatingWithKeyboard}}const r=new p;class w{constructor(e,s){this._isMouseUsed=!1,this._onFocusIn=t=>{if(this._isMouseUsed){this._isMouseUsed=!1;return}if(r.getVal())return;const o=t.details;o.relatedTarget&&(o.isFocusedProgrammatically||o.isFocusedProgrammatically===void 0||r.setVal(!0))},this._onMouseDown=t=>{t.buttons===0||t.clientX===0&&t.clientY===0&&t.screenX===0&&t.screenY===0||(this._isMouseUsed=!0,r.setVal(!1))},this._onKeyDown=t=>{var o;const c=r.getVal(),a=t.keyCode,d=this._triggerKeys;!c&&(!d||d.has(a))?r.setVal(!0):c&&(!((o=this._dismissKeys)===null||o===void 0)&&o.has(a))&&this._scheduleDismiss()},this.id="c"+ ++g,this._win=e;const i=e.document;if(s){const t=s.triggerKeys,o=s.dismissKeys;t!=null&&t.length&&(this._triggerKeys=new Set(t)),o!=null&&o.length&&(this._dismissKeys=new Set(o))}i.addEventListener(l,this._onFocusIn,!0),i.addEventListener("mousedown",this._onMouseDown,!0),e.addEventListener("keydown",this._onKeyDown,!0),m(e),r.add(this)}dispose(){const e=this._win;if(e){this._dismissTimer&&(e.clearTimeout(this._dismissTimer),this._dismissTimer=void 0),b(e);const s=e.document;s.removeEventListener(l,this._onFocusIn,!0),s.removeEventListener("mousedown",this._onMouseDown,!0),e.removeEventListener("keydown",this._onKeyDown,!0),delete this._win,r.remove(this.id)}}isDisposed(){return!!this._win}update(e){var s,i;const t=(i=(s=this._win)===null||s===void 0?void 0:s.__keyborg)===null||i===void 0?void 0:i.refs;if(t)for(const o of Object.keys(t))u.update(t[o],e)}_scheduleDismiss(){const e=this._win;if(e){this._dismissTimer&&(e.clearTimeout(this._dismissTimer),this._dismissTimer=void 0);const s=e.document.activeElement;this._dismissTimer=e.setTimeout(()=>{this._dismissTimer=void 0;const i=e.document.activeElement;s&&i&&s===i&&r.setVal(!1)},k)}}}class u{constructor(e,s){this._cb=[],this._id="k"+ ++g,this._win=e;const i=e.__keyborg;i?(this._core=i.core,i.refs[this._id]=this):(this._core=new w(e,s),e.__keyborg={core:this._core,refs:{[this._id]:this}})}static create(e,s){return new u(e,s)}static dispose(e){e.dispose()}static update(e,s){e._cb.forEach(i=>i(s))}dispose(){var e;const s=(e=this._win)===null||e===void 0?void 0:e.__keyborg;s!=null&&s.refs[this._id]&&(delete s.refs[this._id],Object.keys(s.refs).length===0&&(s.core.dispose(),delete this._win.__keyborg)),this._cb=[],delete this._core,delete this._win}isNavigatingWithKeyboard(){return r.getVal()}subscribe(e){this._cb.push(e)}unsubscribe(e){const s=this._cb.indexOf(e);s>=0&&this._cb.splice(s,1)}setVal(e){r.setVal(e)}}function E(n,e){return u.create(n,e)}function K(n){u.dispose(n)}export{l as K,E as c,K as d,F as n};
//# sourceMappingURL=keyborg-072ac2b1.js.map
